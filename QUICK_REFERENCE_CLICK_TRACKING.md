# Quick Reference: Click Tracking & S2S Postback

## üîë Key Concepts

### 1. **Click ID**
- **What**: Unique UUID v4 identifier for each user click
- **Where**: Generated by backend when user clicks "Start Task"
- **Format**: `550e8400-e29b-41d4-a716-446655440000`
- **Purpose**: Links user click to conversion later

### 2. **Tracking Link (redirectUrl)**
- **What**: The URL user visits to complete the task
- **Contains**: Original taskUrl + `click_id` + `postback_url` parameters
- **Example**: 
  ```
  https://advertiser.com/offer?click_id=abc-123&postback_url=https://yourapp.com/api/v1/earn/postback?click_id=abc-123
  ```

### 3. **Postback URL (S2S)**
- **What**: Endpoint that advertiser calls when user completes task
- **Format**: `https://yourapp.com/api/v1/earn/postback?click_id={clickId}`
- **Called by**: Advertiser's server (not your app)
- **Purpose**: Notify your backend that conversion happened

---

## üìã Flow Summary

```
User Clicks Button
    ‚Üì
Flutter: POST /api/v1/earn/products/:id/click
    ‚Üì
Backend: Generates clickId, creates ClickLog
    ‚Üì
Backend: Returns redirectUrl with clickId
    ‚Üì
Flutter: Opens redirectUrl in WebView
    ‚Üì
User Completes Task on Advertiser Site
    ‚Üì
Advertiser: POST to postback_url with conversion data
    ‚Üì
Backend: Creates Earning, Credits Wallet
    ‚Üì
Done! ‚úÖ
```

---

## üöÄ Flutter Integration (3 Steps)

### Step 1: Call Generate Click API
```dart
POST /api/v1/earn/products/{productId}/click
Headers: Authorization: Bearer {token}
Body: { "taskUrl": "https://advertiser.com/offer" }

Response:
{
  "clickId": "abc-123...",
  "redirectUrl": "https://advertiser.com/offer?click_id=abc-123&postback_url=...",
  "expiresAt": "2024-01-02T12:00:00Z"
}
```

### Step 2: Open redirectUrl in WebView
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => WebViewScreen(url: redirectUrl),
  ),
);
```

### Step 3: Done!
The advertiser will automatically call the postback URL when conversion happens. Your backend handles everything else.

---

## üì° API Endpoints

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/v1/earn/products/:id/click` | POST | ‚úÖ Required | Generate click, get tracking URL |
| `/api/v1/earn/track/:clickId` | GET | ‚ùå Optional | Analytics tracking (optional) |
| `/api/v1/earn/postback?click_id=...` | POST | ‚ùå Public | Called by advertiser (S2S) |

---

## üíª Flutter Code Template

```dart
// 1. Generate click
final api = EarningsApi(token: userToken);
final response = await api.generateClick(
  productId: product.id,
  taskUrl: product.taskUrl,
);

// 2. Open in WebView
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => TaskWebViewScreen(
      redirectUrl: response.redirectUrl,
      clickId: response.clickId,
    ),
  ),
);

// 3. That's it! Postback happens automatically
```

---

## üîç Where Things Are Stored

| Data | Location | Purpose |
|------|----------|---------|
| **Click ID** | Response from generateClick | Track this click |
| **Tracking URL** | Response from generateClick | Open this in WebView |
| **Click Log** | MongoDB `ClickLog` collection | Backend tracking |
| **Earning** | MongoDB `Earning` collection | User credit record |
| **Postback URL** | Automatically included in redirectUrl | Advertiser calls this |

---

## ‚ö†Ô∏è Important Notes

1. **Always use redirectUrl** - Never send user directly to taskUrl
2. **Click expires in 24 hours** - User must complete task within 24h
3. **Postback is automatic** - You don't need to do anything after opening WebView
4. **One click = One conversion** - System prevents duplicate credits
5. **Wallet credit happens automatically** - When postback received with status="completed"

---

## üß™ Test Flow

### 1. Test Click Generation
```bash
curl -X POST http://localhost:3000/api/v1/earn/products/PRODUCT_ID/click \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"taskUrl": "https://example.com"}'
```

### 2. Test Postback (Simulate Advertiser)
```bash
curl -X POST "http://localhost:3000/api/v1/earn/postback?click_id=CLICK_ID" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 50.00,
    "status": "completed",
    "transactionId": "test_123"
  }'
```

---

## üì± Complete Example

See `FLUTTER_INTEGRATION_EXAMPLE.dart` for full working code!

---

## üîó Related Files

- **Full Documentation**: `CLICK_TRACKING_S2S_DOCUMENTATION.md`
- **Flutter Code**: `FLUTTER_INTEGRATION_EXAMPLE.dart`
- **Backend Controller**: `src/controllers/earnings.controller.ts`
- **Models**: `src/models/ClickLog.ts`, `src/models/Earning.ts`

