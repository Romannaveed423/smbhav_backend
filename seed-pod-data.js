const mongoose = require('mongoose');
require('dotenv').config();

// Import models
const PODCategory = require('./dist/models/PODCategory').PODCategory;
const PODProduct = require('./dist/models/PODProduct').PODProduct;
const PODBanner = require('./dist/models/PODBanner').PODBanner;
const PODCoupon = require('./dist/models/PODCoupon').PODCoupon;
const PODCart = require('./dist/models/PODCart').PODCart;
const PODOrder = require('./dist/models/PODOrder').PODOrder;
const PODReview = require('./dist/models/PODReview').PODReview;
const User = require('./dist/models/User').User;

const connectDB = async () => {
  try {
    const dbUrl = process.env.MONGODB_URI || process.env.DATABASE_URL || 'mongodb://localhost:27017/sombhav';
    await mongoose.connect(dbUrl);
    console.log('MongoDB connected');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    process.exit(1);
  }
};

const seedData = async () => {
  try {
    await connectDB();

    // Get or create test user
    let testUser = await User.findOne({ email: 'test@example.com' });
    if (!testUser) {
      console.log('Creating test user...');
      const bcrypt = require('bcryptjs');
      const hashedPassword = await bcrypt.hash('test123', 10);
      testUser = await User.create({
        name: 'Test User',
        email: 'test@example.com',
        phone: '9876543210',
        password: hashedPassword,
        walletBalance: 1000,
      });
    }
    console.log(`Using user: ${testUser.email} (ID: ${testUser._id})`);

    // Clear existing POD data (optional)
    console.log('Clearing existing POD data...');
    await PODCategory.deleteMany({});
    await PODProduct.deleteMany({});
    await PODBanner.deleteMany({});
    await PODCoupon.deleteMany({});
    await PODCart.deleteMany({});
    await PODOrder.deleteMany({});
    await PODReview.deleteMany({});
    console.log('Existing POD data cleared');

    // 1. Create Categories
    console.log('Creating categories...');
    const categories = await PODCategory.insertMany([
      {
        cat_name: 'T-Shirts',
        cat_img: 'https://example.com/images/tshirts.jpg',
        status: 1,
        order: 1,
      },
      {
        cat_name: 'Hoodies',
        cat_img: 'https://example.com/images/hoodies.jpg',
        status: 1,
        order: 2,
      },
      {
        cat_name: 'Mugs',
        cat_img: 'https://example.com/images/mugs.jpg',
        status: 1,
        order: 3,
      },
      {
        cat_name: 'Posters',
        cat_img: 'https://example.com/images/posters.jpg',
        status: 1,
        order: 4,
      },
    ]);
    console.log(`Created ${categories.length} categories`);

    // 2. Create Subcategories
    console.log('Creating subcategories...');
    const subcategories = await PODCategory.insertMany([
      {
        cat_name: 'Round Neck T-Shirts',
        cat_img: 'https://example.com/images/round-neck.jpg',
        status: 1,
        parentCategoryId: categories[0]._id,
        order: 1,
      },
      {
        cat_name: 'V-Neck T-Shirts',
        cat_img: 'https://example.com/images/v-neck.jpg',
        status: 1,
        parentCategoryId: categories[0]._id,
        order: 2,
      },
      {
        cat_name: 'Pullover Hoodies',
        cat_img: 'https://example.com/images/pullover.jpg',
        status: 1,
        parentCategoryId: categories[1]._id,
        order: 1,
      },
      {
        cat_name: 'Zipper Hoodies',
        cat_img: 'https://example.com/images/zipper.jpg',
        status: 1,
        parentCategoryId: categories[1]._id,
        order: 2,
      },
    ]);
    console.log(`Created ${subcategories.length} subcategories`);

    // 3. Create Products
    console.log('Creating products...');
    // Note: productId is auto-generated by pre-save hook, so we create one by one
    const products = [];
    
    const productData = [
      {
        name: 'Premium Cotton T-Shirt',
        categoryId: categories[0]._id,
        subcategoryId: subcategories[0]._id,
        imageUrls: [
          'https://example.com/products/tshirt-1.jpg',
          'https://example.com/products/tshirt-2.jpg',
        ],
        thumbnail: 'https://example.com/products/tshirt-thumb.jpg',
        price: 599,
        discountPrice: 499,
        description: 'Premium quality cotton t-shirt, perfect for custom printing',
        shortDescription: 'Soft cotton t-shirt',
        colors: [
          { id: '1', colorCode: '#FFFFFF', colorName: 'White', isAvailable: true },
          { id: '2', colorCode: '#000000', colorName: 'Black', isAvailable: true },
          { id: '3', colorCode: '#FF0000', colorName: 'Red', isAvailable: true },
          { id: '4', colorCode: '#0000FF', colorName: 'Blue', isAvailable: true },
        ],
        sizes: [
          { size: 'S', isAvailable: true },
          { size: 'M', isAvailable: true },
          { size: 'L', isAvailable: true },
          { size: 'XL', isAvailable: true },
        ],
        materials: ['100% Cotton'],
        productType: 'T-Shirt',
        ratings: [5, 5, 4, 5, 4],
        averageRating: 4.6,
        reviewCount: 5,
        isExpressDelivery: true,
        expressDeliveryDays: 2,
        standardDeliveryDays: 5,
        expressDeliveryPrice: 99,
        standardDeliveryPrice: 0,
        cashbackPercentage: 5,
        isActive: true,
        stock: {
          inStock: true,
          quantity: 100,
        },
      },
      {
        name: 'Comfortable Hoodie',
        categoryId: categories[1]._id,
        subcategoryId: subcategories[2]._id,
        imageUrls: [
          'https://example.com/products/hoodie-1.jpg',
          'https://example.com/products/hoodie-2.jpg',
        ],
        thumbnail: 'https://example.com/products/hoodie-thumb.jpg',
        price: 1299,
        discountPrice: 999,
        description: 'Warm and comfortable hoodie, perfect for winter',
        shortDescription: 'Cozy hoodie',
        colors: [
          { id: '1', colorCode: '#808080', colorName: 'Gray', isAvailable: true },
          { id: '2', colorCode: '#000000', colorName: 'Black', isAvailable: true },
          { id: '3', colorCode: '#8B4513', colorName: 'Brown', isAvailable: true },
        ],
        sizes: [
          { size: 'M', isAvailable: true },
          { size: 'L', isAvailable: true },
          { size: 'XL', isAvailable: true },
          { size: 'XXL', isAvailable: true },
        ],
        materials: ['80% Cotton', '20% Polyester'],
        productType: 'Hoodie',
        ratings: [5, 5, 5, 4, 5],
        averageRating: 4.8,
        reviewCount: 5,
        isExpressDelivery: true,
        expressDeliveryDays: 3,
        standardDeliveryDays: 7,
        expressDeliveryPrice: 149,
        standardDeliveryPrice: 0,
        cashbackPercentage: 7,
        isActive: true,
        stock: {
          inStock: true,
          quantity: 50,
        },
      },
      {
        name: 'Ceramic Coffee Mug',
        categoryId: categories[2]._id,
        imageUrls: [
          'https://example.com/products/mug-1.jpg',
        ],
        thumbnail: 'https://example.com/products/mug-thumb.jpg',
        price: 299,
        discountPrice: 249,
        description: 'High-quality ceramic mug, perfect for custom designs',
        shortDescription: 'Custom ceramic mug',
        colors: [
          { id: '1', colorCode: '#FFFFFF', colorName: 'White', isAvailable: true },
          { id: '2', colorCode: '#000000', colorName: 'Black', isAvailable: true },
        ],
        sizes: [
          { size: '11oz', isAvailable: true },
          { size: '15oz', isAvailable: true },
        ],
        materials: ['Ceramic'],
        productType: 'Mug',
        ratings: [4, 5, 4, 5, 4],
        averageRating: 4.4,
        reviewCount: 5,
        isExpressDelivery: false,
        expressDeliveryDays: 2,
        standardDeliveryDays: 4,
        expressDeliveryPrice: 99,
        standardDeliveryPrice: 0,
        cashbackPercentage: 3,
        isActive: true,
        stock: {
          inStock: true,
          quantity: 200,
        },
      },
      {
        name: 'Premium Poster Print',
        categoryId: categories[3]._id,
        imageUrls: [
          'https://example.com/products/poster-1.jpg',
        ],
        thumbnail: 'https://example.com/products/poster-thumb.jpg',
        price: 199,
        discountPrice: 149,
        description: 'High-quality poster print on premium paper',
        shortDescription: 'Custom poster',
        colors: [],
        sizes: [
          { size: 'A4', isAvailable: true, price: 149 },
          { size: 'A3', isAvailable: true, price: 249 },
          { size: 'A2', isAvailable: true, price: 399 },
        ],
        materials: ['Premium Paper'],
        productType: 'Poster',
        ratings: [5, 4, 5, 4, 5],
        averageRating: 4.6,
        reviewCount: 5,
        isExpressDelivery: true,
        expressDeliveryDays: 2,
        standardDeliveryDays: 5,
        expressDeliveryPrice: 79,
        standardDeliveryPrice: 0,
        cashbackPercentage: 2,
        isActive: true,
        stock: {
          inStock: true,
          quantity: 500,
        },
      },
    ];

    // Create products one by one to trigger pre-save hook for productId
    for (const data of productData) {
      // Manually set productId before save to avoid validation error
      const count = await PODProduct.countDocuments();
      const product = new PODProduct({
        ...data,
        productId: `PROD${String(count + 1).padStart(6, '0')}`,
      });
      await product.save();
      products.push(product);
    }
    console.log(`Created ${products.length} products`);

    // 4. Create Banners
    console.log('Creating banners...');
    await PODBanner.insertMany([
      {
        banner: 'https://example.com/banners/banner1.jpg',
        title: 'Summer Sale',
        subtitle: 'Up to 50% off on all products',
        link: '/products',
        type: 'carousel',
        order: 1,
        isActive: true,
      },
      {
        banner: 'https://example.com/banners/banner2.jpg',
        title: 'New Arrivals',
        subtitle: 'Check out our latest designs',
        link: '/products?new=true',
        type: 'carousel',
        order: 2,
        isActive: true,
      },
      {
        banner: 'https://example.com/banners/banner3.jpg',
        title: 'Express Delivery',
        subtitle: 'Get your orders in 2-3 days',
        link: '/express-delivery',
        type: 'promotional',
        order: 1,
        isActive: true,
        backgroundColor: '#FF6B6B',
      },
    ]);
    console.log('Created 3 banners');

    // 5. Create Coupons
    console.log('Creating coupons...');
    const coupons = await PODCoupon.insertMany([
      {
        couponCode: 'WELCOME10',
        discountType: 'percentage',
        discountValue: 10,
        minPurchaseAmount: 500,
        maxDiscountAmount: 200,
        validFrom: new Date(),
        validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
        usageLimit: 1000,
        usageCount: 0,
        userUsageLimit: 1,
        isActive: true,
        description: '10% off on first order',
      },
      {
        couponCode: 'FLAT50',
        discountType: 'fixed',
        discountValue: 50,
        minPurchaseAmount: 300,
        validFrom: new Date(),
        validUntil: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days
        usageLimit: 500,
        usageCount: 0,
        userUsageLimit: 2,
        applicableCategories: [categories[0]._id, categories[1]._id],
        isActive: true,
        description: 'Flat ₹50 off on clothing',
      },
      {
        couponCode: 'SUMMER25',
        discountType: 'percentage',
        discountValue: 25,
        minPurchaseAmount: 1000,
        maxDiscountAmount: 500,
        validFrom: new Date(),
        validUntil: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000), // 15 days
        usageLimit: 200,
        usageCount: 0,
        isActive: true,
        description: '25% off on orders above ₹1000',
      },
    ]);
    console.log(`Created ${coupons.length} coupons`);

    // 6. Create Cart Items
    console.log('Creating cart items...');
    const cartItems = [];
    const cartData = [
      {
        userId: testUser._id,
        productId: products[0]._id,
        quantity: 2,
        selectedColor: {
          id: '1',
          colorCode: '#FFFFFF',
          colorName: 'White',
        },
        selectedSize: 'M',
        deliveryType: 'standard',
        unitPrice: products[0].discountPrice,
        totalPrice: products[0].discountPrice * 2,
        deliveryPrice: products[0].standardDeliveryPrice,
        estimatedDelivery: new Date(Date.now() + products[0].standardDeliveryDays * 24 * 60 * 60 * 1000),
      },
      {
        userId: testUser._id,
        productId: products[1]._id,
        quantity: 1,
        selectedColor: {
          id: '1',
          colorCode: '#808080',
          colorName: 'Gray',
        },
        selectedSize: 'L',
        deliveryType: 'express',
        unitPrice: products[1].discountPrice,
        totalPrice: products[1].discountPrice,
        deliveryPrice: products[1].expressDeliveryPrice,
        estimatedDelivery: new Date(Date.now() + products[1].expressDeliveryDays * 24 * 60 * 60 * 1000),
      },
    ];
    
    // Create cart items one by one to trigger pre-save hook for cartItemId
    for (const data of cartData) {
      const count = await PODCart.countDocuments();
      const cartItem = new PODCart({
        ...data,
        cartItemId: `CART${String(count + 1).padStart(6, '0')}`,
      });
      await cartItem.save();
      cartItems.push(cartItem);
    }
    console.log(`Created ${cartItems.length} cart items`);

    // 7. Create Orders
    console.log('Creating orders...');
    const orderData = [
      {
        userId: testUser._id,
        status: 'delivered',
        trackingNumber: 'TRACK123456',
        items: [
          {
            productId: products[0]._id,
            productName: products[0].name,
            productImage: products[0].thumbnail,
            quantity: 1,
            selectedColor: 'White',
            selectedSize: 'M',
            unitPrice: products[0].discountPrice,
            totalPrice: products[0].discountPrice,
          },
        ],
        summary: {
          subtotal: products[0].discountPrice,
          deliveryCharges: 0,
          discount: 0,
          couponDiscount: 0,
          total: products[0].discountPrice,
          cashback: Math.round(products[0].discountPrice * products[0].cashbackPercentage / 100),
        },
        shippingAddress: {
          name: 'Test User',
          phone: '9876543210',
          email: 'test@example.com',
          addressLine1: '123 Main Street',
          city: 'Mumbai',
          state: 'Maharashtra',
          pincode: '400001',
          country: 'India',
          addressType: 'home',
        },
        paymentMethod: {
          type: 'online',
          paymentId: 'PAY123456',
          transactionId: 'TXN123456',
        },
        deliveryType: 'standard',
        estimatedDelivery: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
        deliveredAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
        timeline: [
          { title: 'Order Placed', description: 'Your order has been placed', date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
          { title: 'Confirmed', description: 'Order confirmed', date: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
          { title: 'Shipped', description: 'Order shipped', date: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
          { title: 'Delivered', description: 'Order delivered', date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
        ],
        placedAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
      },
      {
        userId: testUser._id,
        status: 'shipped',
        trackingNumber: 'TRACK789012',
        items: [
          {
            productId: products[1]._id,
            productName: products[1].name,
            productImage: products[1].thumbnail,
            quantity: 1,
            selectedColor: 'Gray',
            selectedSize: 'L',
            unitPrice: products[1].discountPrice,
            totalPrice: products[1].discountPrice,
          },
        ],
        summary: {
          subtotal: products[1].discountPrice,
          deliveryCharges: products[1].expressDeliveryPrice,
          discount: 0,
          couponDiscount: 0,
          total: products[1].discountPrice + products[1].expressDeliveryPrice,
          cashback: Math.round(products[1].discountPrice * products[1].cashbackPercentage / 100),
        },
        shippingAddress: {
          name: 'Test User',
          phone: '9876543210',
          email: 'test@example.com',
          addressLine1: '123 Main Street',
          city: 'Mumbai',
          state: 'Maharashtra',
          pincode: '400001',
          country: 'India',
        },
        paymentMethod: {
          type: 'cod',
        },
        deliveryType: 'express',
        estimatedDelivery: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),
        timeline: [
          { title: 'Order Placed', description: 'Your order has been placed', date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
          { title: 'Confirmed', description: 'Order confirmed', date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), completed: true, isCurrent: false },
          { title: 'Shipped', description: 'Order shipped', date: new Date().toISOString(), completed: true, isCurrent: true },
        ],
        placedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
      },
      {
        userId: testUser._id,
        status: 'pending',
        items: [
          {
            productId: products[2]._id,
            productName: products[2].name,
            productImage: products[2].thumbnail,
            quantity: 2,
            selectedColor: 'White',
            selectedSize: '11oz',
            unitPrice: products[2].discountPrice,
            totalPrice: products[2].discountPrice * 2,
          },
        ],
        summary: {
          subtotal: products[2].discountPrice * 2,
          deliveryCharges: 0,
          discount: 0,
          couponDiscount: 0,
          total: products[2].discountPrice * 2,
          cashback: Math.round(products[2].discountPrice * 2 * products[2].cashbackPercentage / 100),
        },
        shippingAddress: {
          name: 'Test User',
          phone: '9876543210',
          email: 'test@example.com',
          addressLine1: '123 Main Street',
          city: 'Mumbai',
          state: 'Maharashtra',
          pincode: '400001',
          country: 'India',
        },
        paymentMethod: {
          type: 'online',
        },
        deliveryType: 'standard',
        estimatedDelivery: new Date(Date.now() + products[2].standardDeliveryDays * 24 * 60 * 60 * 1000),
        timeline: [
          { title: 'Order Placed', description: 'Your order has been placed', date: new Date().toISOString(), completed: true, isCurrent: true },
        ],
        placedAt: new Date(),
      },
    ];
    
    // Create orders one by one to trigger pre-save hook for orderId and orderNumber
    const orders = [];
    for (const data of orderData) {
      const count = await PODOrder.countDocuments();
      const order = new PODOrder({
        ...data,
        orderId: `ORD${String(count + 1).padStart(8, '0')}`,
        orderNumber: `ORD-${String(count + 1).padStart(5, '0')}`,
      });
      await order.save();
      orders.push(order);
    }
    console.log(`Created ${orders.length} orders`);

    // 8. Create Reviews
    console.log('Creating reviews...');
    const reviewData = [
      {
        userId: testUser._id,
        productId: products[0]._id,
        orderId: orders[0]._id,
        rating: 5,
        comment: 'Great quality t-shirt, very comfortable!',
        images: ['https://example.com/reviews/review1.jpg'],
        pros: ['Good quality', 'Fast delivery'],
        cons: [],
        verifiedPurchase: true,
        helpful: 10,
      },
      {
        userId: testUser._id,
        productId: products[1]._id,
        orderId: orders[1]._id,
        rating: 4,
        comment: 'Nice hoodie, but could be warmer',
        pros: ['Good fit', 'Nice design'],
        cons: ['Could be warmer'],
        verifiedPurchase: true,
        helpful: 5,
      },
    ];
    
    // Create reviews one by one to trigger pre-save hook for reviewId
    for (const data of reviewData) {
      const count = await PODReview.countDocuments();
      const review = new PODReview({
        ...data,
        reviewId: `REV${String(count + 1).padStart(6, '0')}`,
      });
      await review.save();
    }
    console.log('Created 2 reviews');

    console.log('\n✅ POD seed data created successfully!');
    console.log('\nSummary:');
    console.log(`- Categories: ${categories.length}`);
    console.log(`- Subcategories: ${subcategories.length}`);
    console.log(`- Products: ${products.length}`);
    console.log(`- Banners: 3`);
    console.log(`- Coupons: ${coupons.length}`);
    console.log(`- Cart Items: ${cartItems.length}`);
    console.log(`- Orders: ${orders.length}`);
    console.log(`- Reviews: 2`);
    console.log(`\nTest User: ${testUser.email}`);
    console.log(`User ID: ${testUser._id}`);

    process.exit(0);
  } catch (error) {
    console.error('Error seeding data:', error);
    process.exit(1);
  }
};

seedData();

